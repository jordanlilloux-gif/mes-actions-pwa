<script>
/**
 * Auto-register (push) device in Google Sheet via GAS:
 *   .../exec?mode=registerdevice&me=...&sig=...&deviceId=...&token=...&platform=...&appVersion=...&ua=...
 *
 * Prérequis :
 * - La WebApp "Mes actions" doit avoir stocké dans localStorage :
 *   acr.email, acr.sig (et idéalement acr.exec)
 */
(function(){
  function get(k){ try { return localStorage.getItem(k) || ""; } catch(e){ return ""; } }
  function set(k,v){ try { localStorage.setItem(k, v); } catch(e){} }

  // Throttle : on évite d’appeler à chaque ouverture (ex: toutes les 6h max)
  var now = Date.now();
  var last = parseInt(get("acr.push.lastRegisterAt") || "0", 10);
  if (last && (now - last) < 6 * 60 * 60 * 1000) return;

  var me  = (get("acr.email") || "").trim().toLowerCase();
  var sig = (get("acr.sig") || "").trim();

  // Exec URL (idéalement injecté par la WebApp). Fallback: dérive de ENTRY_URL.
  var exec = (get("acr.exec") || "").trim();
  if (!exec) {
    try {
      // ENTRY_URL existe dans ce fichier (script plus haut). On peut en déduire /exec sans paramètres.
      var u = new URL(ENTRY_URL);
      exec = u.origin + u.pathname; // .../exec
    } catch(e) {}
  }

  // Sans identité signée, on ne fait rien.
  if (!me || !sig || !exec) return;

  // deviceId stable (différent du deviceId “auth” si tu veux les séparer)
  var deviceId = (get("acr.pushDeviceId") || "").trim();
  if (!deviceId) {
    deviceId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID()
             : ("dev-" + Date.now() + "-" + Math.random().toString(16).slice(2));
    set("acr.pushDeviceId", deviceId);
  }

  // Platform simple
  var ua = navigator.userAgent || "";
  var platform =
      /iphone|ipad|ipod/i.test(ua) ? "ios" :
      /android/i.test(ua) ? "android" :
      "desktop";

  // Token placeholder pour l’instant (on mettra le vrai token FCM plus tard)
  var token = "pending";

  // Version PWA (alignée sur ton SW_VERSION v1.0.3)
  var appVersion = "1.0.3";

  var url =
      exec
    + "?mode=registerdevice"
    + "&me=" + encodeURIComponent(me)
    + "&sig=" + encodeURIComponent(sig)
    + "&deviceId=" + encodeURIComponent(deviceId)
    + "&token=" + encodeURIComponent(token)
    + "&platform=" + encodeURIComponent(platform)
    + "&appVersion=" + encodeURIComponent(appVersion)
    + "&ua=" + encodeURIComponent(ua.slice(0,180))
    + "&ts=" + now;

  try {
    (new Image()).src = url;
    set("acr.push.lastRegisterAt", String(now));
  } catch(e) {}
})();
</script>
