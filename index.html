<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Mes Actions</title>

  <!-- PWA / Android -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#16a34a" />

  <!-- iOS "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Mes Actions" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon-180.png" />

  <!-- Favicon -->
  <link rel="icon" sizes="32x32" href="./icons/favicon-32.png" />

  <style>
    :root { --green:#16a34a; --bg:#f6f7f9; --fg:#111; --muted:#6b7280; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--fg);
      padding:16px;
    }
    .box{
      max-width:720px; margin:0 auto; background:#fff;
      border:1px solid #e5e7eb; border-radius:14px; padding:16px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      display:inline-block; padding:12px 14px; border-radius:12px;
      border:1px solid #e5e7eb; text-decoration:none; font-weight:700;
      background:#fff; color:#111;
    }
    .btn-primary{ background:var(--green); color:#fff; border-color:var(--green); }
    .muted{ color:var(--muted); font-size:13px; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .kv{ width:100%; border-collapse:collapse; margin-top:10px; }
    .kv td{ border-top:1px solid #f1f5f9; padding:8px 6px; vertical-align:top; }
    .kv td:first-child{ width:180px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="box">
    <h2 id="title">Mes Actions</h2>

    <p class="muted">
      Démarrage… si rien ne se passe, utilise le bouton ci-dessous.
    </p>

    <div class="row" style="margin:10px 0 6px 0">
      <a class="btn btn-primary" id="goBtn" href="#">Ouvrir Mes actions</a>
      <a class="btn" href="./offline.html">Mode hors-ligne</a>
    </div>

    <!-- Install iOS (instructions) -->
    <div id="iosInstallHelp" style="display:none; margin-top:14px">
      <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
        <div style="font-weight:800; margin-bottom:6px">Installer sur iPhone / iPad</div>
        <div class="muted" style="font-size:14px; line-height:1.4">
          1) Ouvre dans <strong>Safari</strong><br/>
          2) Appuie sur <strong>Partager</strong> (⬆️)<br/>
          3) Choisis <strong>Sur l’écran d’accueil / Ajouter à l’écran d’accueil</strong>
          4) Laisse activé <strong>Ouvrir comme app web</strong>.<br/>
          5) Appuie sur <strong>Ajouter</strong>.
        </div>
      </div>
    </div>

    <!-- Install Android (button, shown only if beforeinstallprompt fires) -->
    <div id="androidInstallBox" style="display:none; margin-top:14px">
      <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
        <div style="font-weight:800; margin-bottom:6px">Installer l’application</div>
        <div class="row" style="margin-top:8px">
          <a class="btn" id="androidInstallBtn" href="#" style="font-weight:800">Installer sur Android</a>
        </div>
        <div class="muted" style="margin-top:8px">
          Si le bouton n’apparaît pas : menu ⋮ → <strong>Installer l’application</strong>.
        </div>
      </div>
    </div>

    <!-- Zone debug -->
    <div id="debugArea" style="display:none; margin-top:14px">
      <p class="muted">
        Mode debug activé (<code>?pwa_dbg=1</code>) — pas de redirection automatique.
      </p>
      <table class="kv">
        <tr><td>Destination</td><td class="mono" id="destCell"></td></tr>
        <tr><td>URL actuelle</td><td class="mono" id="hereCell"></td></tr>
        <tr><td>Standalone</td><td class="mono" id="standCell"></td></tr>
        <tr><td>SW support</td><td class="mono" id="swCell"></td></tr>
        <tr><td>Manifest</td><td class="mono" id="manCell"></td></tr>
      </table>
    </div>
  </div>

<script>
  // === CONFIGURATION ===
  const ENTRY_URL =
    "https://script.google.com/macros/s/AKfycbwLIoqEXc_156juJNszZPRiAH2adBh4NmMxLN1JwdOkeAxaTuH_nklP9DbQODK4GRxq/exec"
    + "?mode=entry&audience=leaders&ek=e187f8a94f7f47b1a933d73c";

  // ✅ Seed localStorage for GitHub Pages origin (safe, no secrets)
  (function seedAcrUrls(){
    try {
      // (non sensibles) : on écrit TOUJOURS pour éviter les états obsolètes
      localStorage.setItem("acr.entry", ENTRY_URL);

      const u = new URL(ENTRY_URL);
      localStorage.setItem("acr.exec", u.origin + u.pathname); // base /exec canonique

      // version de schéma côté PWA (utile si tu changes de stratégie plus tard)
      localStorage.setItem("acr.pwaSchema", "v1");
    } catch(e) {}
  })();

  // === Helpers ===
  function qs(name){
    try { return new URL(location.href).searchParams.get(name); }
    catch(e){ return null; }
  }

    function isStandaloneMode(){
      if (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) return true;
      if ("standalone" in navigator && navigator.standalone) return true; // iOS
      return false;
    }

    function go(url){
      try { location.replace(url); }
      catch(e){ location.href = url; }
    }

    // === Init ===
    (function(){
      const dbg = qs("pwa_dbg") === "1";
      const standalone = isStandaloneMode();
      const dest = ENTRY_URL + "&src=pwa";

      // --- Install UI (iOS + Android) ---
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

      // iOS: show instructions only when NOT installed (not standalone)
      if (isIOS && !standalone) {
        const iosHelp = document.getElementById("iosInstallHelp");
        if (iosHelp) iosHelp.style.display = "block";
      }

      // Android: show install button only if Chrome provides beforeinstallprompt
      let deferredInstallPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        if (!standalone) {
          const box = document.getElementById("androidInstallBox");
          if (box) box.style.display = "block";
        }
      });

      const installBtn = document.getElementById("androidInstallBtn");
      if (installBtn) {
        installBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (!deferredInstallPrompt) return;
          deferredInstallPrompt.prompt();
          try { await deferredInstallPrompt.userChoice; } catch(_) {}
          deferredInstallPrompt = null;
          const box = document.getElementById("androidInstallBox");
          if (box) box.style.display = "none";
        });
      }

      // Bouton "Ouvrir Mes actions" : ne JAMAIS quitter vers Apps Script si offline
      const goBtn = document.getElementById("goBtn");
      goBtn.addEventListener("click", (e) => {
        e.preventDefault();
        // Offline -> rester sur GitHub Pages et afficher la page offline
        if (!navigator.onLine) {
          go("./offline.html");
          return;
        }
        // Online -> aller vers la WebApp ENTRY
        go(dest);
      });

      // Optionnel : éviter toute navigation par défaut via href (sécurité)
      // (on le laisse à "#" et on gère tout en JS)
      goBtn.href = "#";

      if (dbg){
        document.getElementById("debugArea").style.display = "block";
        document.getElementById("title").textContent = "Mes Actions (DEBUG)";
        document.getElementById("destCell").textContent = dest;
        document.getElementById("hereCell").textContent = location.href;
        document.getElementById("standCell").textContent = standalone ? "oui" : "non";
        document.getElementById("swCell").textContent = ("serviceWorker" in navigator) ? "oui" : "non";
        document.getElementById("manCell").textContent = "manifest.json chargé";
        return;
      }

      // Auto-redirection uniquement si installé (standalone)
      if (standalone){
        // Offline => ne jamais quitter GitHub Pages
        if (!navigator.onLine) {
          go("./offline.html");
          return;
        }
        // Online => redirection immédiate vers ENTRY
        go(dest);
      }
    })();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  </script>

</body>
</html>
